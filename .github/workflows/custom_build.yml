name: Custom RustDesk Build (Native Windows)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      RELAY: ${{ secrets.RELAY }}
      RENDEZVOUS: ${{ secrets.RENDEZVOUS }}
      API: ${{ secrets.API }}
      UNATTENDED_PASSWORD: ${{ secrets.UNATTENDED_PASSWORD }}

    steps:
      - name: Checkout source with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        run: |
          rustup set profile minimal
          rustup toolchain install stable
          rustup default stable

      - name: Install build dependencies
        shell: pwsh
        run: |
          choco install -y cmake ninja nasm openssl.light

      - name: Verify environment
        shell: pwsh
        run: |
          rustc -V
          cargo -V
          cmake -version
          ninja --version

      - name: Prepare custom config
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path src | Out-Null
          $file = "src/custom_config.rs"
          Set-Content $file "// Auto-generated config for your custom RustDesk build"
          Add-Content $file "pub const RENDEZVOUS_SERVER: &str = `"$env:RENDEZVOUS`";"
          Add-Content $file "pub const RELAY_SERVER: &str = `"$env:RELAY`";"
          Add-Content $file "pub const API_SERVER: &str = `"$env:API`";"
          if ($env:UNATTENDED_PASSWORD) {
            Add-Content $file "pub const DEFAULT_UNATTENDED_PASSWORD: &str = `"$env:UNATTENDED_PASSWORD`";"
          }
          Write-Host "✅ custom_config.rs created successfully"

      - name: Inject config into RustDesk
        shell: pwsh
        run: |
          if (Test-Path "src/config.rs") {
            (Get-Content src/config.rs) | Set-Content src/config.rs.bak
            $inject = "mod custom_config;`nuse custom_config::*;`n"
            (Get-Content src/config.rs.bak) | Set-Content src/config.rs
            Add-Content -Path src/config.rs -Value $inject
            Write-Host "✅ Injected custom_config into src/config.rs"
          }

      - name: Build RustDesk (Release)
        shell: pwsh
        run: |
          cargo build --release
          Write-Host "✅ RustDesk build completed"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-custom-client
          path: target/release/rustdesk.exe
